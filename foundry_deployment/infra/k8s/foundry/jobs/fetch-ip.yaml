apiVersion: batch/v1
kind: CronJob
metadata:
  name: fetch-vm-public-ip
  namespace: foundry
spec:
  schedule: "*/15 * * * *"
  concurrencyPolicy: Replace
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: ip-fetcher
              image: docker.io/mephalrith/fetch-foundry-ip:v0.1
              imagePullPolicy: Always
              env:
                - name: API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: cloudflare
                      key: dns-api-key
                - name: SERVICE_URL
                  value: "http://prometheus-stack-prometheus-pushgateway.monitoring.svc.cluster.local:9091"
                - name: ZONE_ID
                  valueFrom:
                    secretKeyRef:
                      name: cloudflare
                      key: dns-zone-id
                - name: RECORDS
                  valueFrom:
                    secretKeyRef:
                      name: cloudflare
                      key: dns-record-ids